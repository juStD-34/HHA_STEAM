<!doctype html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng T∆∞ V·∫•n Ngh·ªÅ Nghi·ªáp ƒêa NƒÉng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .chu{
            margin-top: 77px !important;
        }

        .card {
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            background-color: #1e293b;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* Reflex Visual Demo (Punch Board) */
        .punch-board{
            display:grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 14px;
            padding: 18px;
            border-radius: 18px;
            background: radial-gradient(120% 120% at 30% 20%, rgba(59,130,246,0.12), rgba(2,6,23,0.0)),
                        rgba(2,6,23,0.35);
            border: 1px solid rgba(148,163,184,0.25);
            box-shadow: inset 0 10px 24px rgba(0,0,0,0.35);
        }
        .punch-hole{
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 999px;
            background: rgba(51,65,85,0.9);
            border: 1px solid rgba(148,163,184,0.18);
            box-shadow: inset 0 12px 0 rgba(0,0,0,0.45);
            overflow: hidden;
            cursor: pointer;
            transform: translateZ(0);
            transition: transform 120ms ease, box-shadow 120ms ease;
        }
        .punch-hole:active{
            transform: scale(0.97);
        }
        .punch-mouse{
            position:absolute;
            left: 50%;
            top: 120%;
            transform: translate(-50%, 0);
            font-size: 28px;
            filter: drop-shadow(0 6px 10px rgba(0,0,0,0.35));
            transition: top 110ms ease;
            user-select:none;
            pointer-events:none;
        }
        .punch-hole.up .punch-mouse{
            top: 18%;
        }
        .punch-hole.hit{
            box-shadow: inset 0 12px 0 rgba(0,0,0,0.55), 0 0 0 6px rgba(234,179,8,0.15);
        }
        .punch-hole.hit::after{
            content:'';
            position:absolute;
            inset:-10%;
            border-radius:999px;
            border: 2px solid rgba(234,179,8,0.35);
            animation: punchRipple 380ms ease-out forwards;
        }
        @keyframes punchRipple{
            from{ transform: scale(0.6); opacity: 0.9;}
            to{ transform: scale(1.15); opacity: 0;}
        }

        .result-highlight {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .chat-message {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            line-height: 1.4;
            white-space: pre-line;
        }

        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border-bottom-right-radius: 0.25rem;
        }

        .chat-message.bot .chat-bubble {
            background-color: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-bottom-left-radius: 0.25rem;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(148, 163, 184, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        @media (max-width: 640px) {
            .chat-bubble {
                max-width: 90%;
            }
        }
    </style>
</head>

<body class="min-h-screen bg-[#0f172a] p-0 m-0">

    <header class="bg-slate-950/80 border-b border-white/10">
        <div
            class="max-w-6xl mx-auto px-4 py-8 flex flex-col gap-4 md:flex-row md:items-center md:justify-between text-center md:text-left">
            <div>
                <p
                    class="text-emerald-300 font-bold tracking-[0.2em] uppercase text-xs mb-2 drop-shadow-md inline-block px-4 py-1 rounded-full border border-emerald-500/20">
                    B·ªô test ngh·ªÅ nghi·ªáp</p>
                <h1 class="text-3xl md:text-5xl font-black text-white leading-tight">
                    Ho√†n th√†nh 3 b√†i ki·ªÉm tra ƒë·ªÉ m·ªü kh√≥a t∆∞ v·∫•n c√° nh√¢n h√≥a
                </h1>
                <p class="text-slate-400 mt-3 text-sm md:text-base max-w-2xl">
                    Nh·∫≠p k·∫øt qu·∫£ t·ª´ thi·∫øt b·ªã Wire Loop, tr√≤ ch∆°i ƒë·∫≠p chu·ªôt v√† tr√≤ chuy·ªán c√πng chuy√™n gia AI ƒë·ªÉ nh·∫≠n ph√¢n
                    t√≠ch ch√≠nh x√°c nh·∫•t cho k·∫ø ho·∫°ch ngh·ªÅ nghi·ªáp c·ªßa b·∫°n.
                </p>
            </div>
            <div class="flex flex-col items-center md:items-end gap-1 text-center md:text-right">
                {% set locked = not tests_completed %}
                <a id="home-link" href="{{ url_for('home') }}"
                    class="inline-flex items-center gap-2 text-sm font-semibold text-emerald-300 transition {{ 'opacity-60 cursor-not-allowed pointer-events-none' if locked else 'hover:text-emerald-200' }}"
                    aria-disabled="{{ 'true' if locked else 'false' }}">
                    <span aria-hidden="true">‚Üê</span> V·ªÅ trang ch·ªß
                </a>
                <p id="home-lock-message"
                    class="text-xs text-rose-300 {{ 'hidden' if not locked else '' }}">
                    Ho√†n th√†nh b√°o c√°o ƒë·ªÉ quay l·∫°i trang ch·ªß.
                </p>
            </div>
        </div>
    </header>

    <!-- Student Info Modal -->
    <div id="student-info-modal"
        class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 flex items-center justify-center px-4 py-8 {{ 'hidden' if student_info and student_info.get('age') else '' }}">
        <form id="student-info-form"
            class="w-full max-w-lg bg-slate-900 border border-white/10 rounded-2xl p-6 space-y-4 shadow-2xl">
            <div>
                <p class="text-emerald-300 text-xs uppercase tracking-[0.2em] font-semibold mb-2">Th√¥ng tin h·ªçc sinh</p>
                <h2 class="text-2xl font-bold text-white">Vui l√≤ng cung c·∫•p th√¥ng tin tr∆∞·ªõc khi l√†m b√†i</h2>
                <p class="text-slate-400 text-sm mt-1">Th√¥ng tin gi√∫p c√° nh√¢n ho√° b√°o c√°o cho b·∫°n.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-xs font-semibold text-slate-400 mb-1">H·ªç v√† t√™n</label>
                    <input id="student-fullname" type="text" required
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-emerald-400 focus:outline-none"
                        placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-400 mb-1">Tu·ªïi</label>
                    <input id="student-age" type="number" min="10" max="25" required
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-emerald-400 focus:outline-none"
                        placeholder="17">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-400 mb-1">Gi·ªõi t√≠nh</label>
                    <select id="student-gender" required
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-emerald-400 focus:outline-none">
                        <option value="" disabled selected>Ch·ªçn gi·ªõi t√≠nh</option>
                        <option value="Nam">Nam</option>
                        <option value="N·ªØ">N·ªØ</option>
                        <option value="Kh√°c">Kh√°c</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-400 mb-1">Kh·ªëi</label>
                    <select id="student-grade" required
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-emerald-400 focus:outline-none">
                        <option value="" disabled selected>Ch·ªçn kh·ªëi</option>
                        <option value="10">Kh·ªëi 10</option>
                        <option value="11">Kh·ªëi 11</option>
                        <option value="12">Kh·ªëi 12</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs font-semibold text-slate-400 mb-1">L·ªõp</label>
                    <input id="student-class" type="text" required
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-emerald-400 focus:outline-none"
                        placeholder="V√≠ d·ª•: 12A1">
                </div>
            </div>

            <p id="student-info-error" class="text-sm text-red-400 hidden">Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.</p>

            <button type="submit"
                class="w-full bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold py-3 rounded-xl transition">
                B·∫Øt ƒë·∫ßu l√†m b√†i
            </button>
        </form>
    </div>

    <!-- Main Content Container -->
    <div id="test-section" class="max-w-4xl mx-auto space-y-8 p-4 md:p-8 mt-8 relative z-20">
        <!-- Game 1: Wire Loop -->
        <div class="card p-6 rounded-2xl fade-in border-l-4 border-blue-500 relative overflow-hidden" id="step1-card">
            <div class="absolute top-0 right-0 p-4 opacity-5 text-9xl font-black">1</div>
            <div class="flex items-center gap-4 mb-6 relative z-10">
                <div class="step-number">1</div>
                <div>
                    <h2 class="text-xl font-bold text-white">Ki·ªÉm Tra Kh√©o L√©o (Wire Loop)</h2>
                    <p class="text-slate-400 text-sm">K·∫øt n·ªëi v·ªõi thi·∫øt b·ªã ESP32 ho·∫∑c nh·∫≠p th·ªß c√¥ng</p>
                </div>
            </div>

            <!-- Live Monitor UI -->
            <div id="live-monitor" class="hidden mb-6 bg-slate-900/80 p-6 rounded-xl border border-blue-500/30">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-blue-400 font-bold uppercase tracking-wider text-xs">‚óè ƒêang k·∫øt n·ªëi thi·∫øt
                        b·ªã</span>
                    <span class="text-slate-500 text-xs font-mono">LIVE DATA</span>
                </div>
                <div class="grid grid-cols-2 gap-8 text-center">
                    <div>
                        <div class="text-slate-400 text-xs mb-1">Th·ªùi Gian</div>
                        <div class="text-3xl font-mono font-bold text-white"><span id="live-time">0.0</span>s</div>
                    </div>
                    <div>
                        <div class="text-slate-400 text-xs mb-1">S·ªë L·ªói</div>
                        <div class="text-3xl font-mono font-bold text-red-500" id="live-errors">0</div>
                    </div>
                </div>
            </div>

            <!-- Step 1 Result Display (Auto-filled) -->
            <div id="step1-result-display" class="hidden mb-6 bg-slate-800 p-6 rounded-xl border border-emerald-500/50">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-emerald-400 font-bold uppercase tracking-wider text-sm">‚úÖ K·∫øt qu·∫£ t·ª´ thi·∫øt
                        b·ªã</span>
                    <button onclick="resetStep1()" class="text-slate-400 text-xs hover:text-white underline">Nh·∫≠p l·∫°i
                        th·ªß c√¥ng</button>
                </div>
                <div class="grid grid-cols-2 gap-8 text-center">
                    <div>
                        <div class="text-slate-400 text-xs mb-1">Th·ªùi Gian</div>
                        <div class="text-3xl font-mono font-bold text-white"><span id="display-time">0.0</span>s</div>
                    </div>
                    <div>
                        <div class="text-slate-400 text-xs mb-1">S·ªë L·ªói</div>
                        <div class="text-3xl font-mono font-bold text-red-500" id="display-errors">0</div>
                    </div>
                </div>
            </div>

            <!-- Manual Input Form -->
            <div id="step1-manual-form">
                <div class="mb-4">
                    <p class="text-slate-400 text-sm italic border-l-2 border-slate-600 pl-3">
                        * N·∫øu kh√¥ng k·∫øt n·ªëi thi·∫øt b·ªã IoT, h√£y nh·∫≠p k·∫øt qu·∫£ th·ªß c√¥ng v√†o b√™n d∆∞·ªõi:
                    </p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">Th·ªùi gian (gi√¢y)</label>
                        <input type="number" id="input-time"
                            class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none transition-colors"
                            placeholder="0.0">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-400 mb-1">S·ªë l·∫ßn ch·∫°m (l·ªói)</label>
                        <input type="number" id="input-errors"
                            class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none transition-colors"
                            placeholder="0">
                    </div>
                </div>
                <div class="mt-4 flex flex-col gap-3 sm:flex-row sm:items-center">
                    <button onclick="submitWireLoopResult()" id="wire-submit-btn"
                        class="bg-blue-600 hover:bg-blue-500 text-white font-semibold px-5 py-3 rounded-lg transition shadow-lg shadow-blue-600/30 w-full sm:w-auto text-center">
                        G·ª≠i k·∫øt qu·∫£ Wire Loop
                    </button>
                    <p id="step1-api-message" class="hidden text-sm text-emerald-400">ƒê√£ c·∫≠p nh·∫≠t k·∫øt qu·∫£.</p>
                </div>
            </div>

            <div id="step1-status"
                class="mt-4 hidden p-3 bg-emerald-500/10 border border-emerald-500/20 rounded-lg flex items-center gap-2 text-emerald-500 text-sm font-bold">
                <span>‚úÖ ƒê√£ ghi nh·∫≠n k·∫øt qu·∫£ B∆∞·ªõc 1!</span>
            </div>
            <div id="step1-best-summary"
                class="mt-2 hidden text-sm text-slate-300">
                üéØ K·ª∑ l·ª•c hi·ªán t·∫°i: <span id="best-step1-time">--</span>s | <span id="best-step1-errors">--</span> l·ªói
            </div>
        </div>

        <!-- Game 2: Reflex (Playable) -->
        <div class="card p-6 rounded-2xl fade-in border-l-4 border-yellow-500 relative overflow-hidden" id="step2-card">
            <div class="absolute top-0 right-0 p-4 opacity-5 text-9xl font-black">2</div>
            <div class="flex items-center gap-4 mb-6 relative z-10">
                <div class="step-number bg-gradient-to-br from-yellow-500 to-orange-500 !shadow-yellow-500/50">2</div>
                <div>
                    <h2 class="text-xl font-bold text-white">Ki·ªÉm Tra Ph·∫£n X·∫° (ƒê·∫≠p Chu·ªôt)</h2>
                    <p class="text-slate-400 text-sm">Ch∆°i tr·ª±c ti·∫øp tr√™n m√°y v√† h·ªá th·ªëng t·ª± ghi l·∫°i ƒëi·ªÉm</p>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-6 items-start">
                <!-- Left: Scoreboard + controls -->
                <div class="bg-slate-900/40 p-5 rounded-2xl border border-slate-700 space-y-4">
                    <div>
                        <p class="text-sm text-slate-200 font-semibold">H∆∞·ªõng d·∫´n</p>
                        <p class="text-xs text-slate-400 mt-1 leading-relaxed">
                            Nh·∫•n ‚ÄúB·∫Øt ƒë·∫ßu‚Äù ƒë·ªÉ ch∆°i trong 10 gi√¢y. Khi bi·ªÉu t∆∞·ª£ng chu·ªôt nh√¥ l√™n, click ƒë·ªÉ ƒë·∫≠p ch√∫ng.
                            ƒêi·ªÉm s·ªë s·∫Ω g·ª≠i t·ª± ƒë·ªông v·ªÅ h·ªá th·ªëng sau khi h·∫øt gi·ªù.
                        </p>
                    </div>

                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div class="bg-slate-900/70 rounded-xl p-4 border border-slate-700">
                            <p class="text-xs text-slate-400 uppercase tracking-[0.2em]">Th·ªùi gian</p>
                            <p id="reflex-time-remaining" class="text-2xl font-bold text-white mt-1">10s</p>
                        </div>
                        <div class="bg-slate-900/70 rounded-xl p-4 border border-slate-700">
                            <p class="text-xs text-slate-400 uppercase tracking-[0.2em]">S·ªë chu·ªôt</p>
                            <p id="reflex-score" class="text-2xl font-bold text-amber-300 mt-1">0</p>
                        </div>
                        <div class="col-span-2 bg-slate-900/70 rounded-xl p-4 border border-slate-700">
                            <p class="text-xs text-slate-400 uppercase tracking-[0.2em]">Tr·∫°ng th√°i</p>
                            <p id="reflex-status" class="text-lg font-semibold text-white mt-1">Ch∆∞a b·∫Øt ƒë·∫ßu</p>
                        </div>
                    </div>

                    <button id="reflex-start-btn" onclick="startReflexGame()"
                        class="bg-yellow-500 hover:bg-yellow-400 text-slate-900 font-semibold px-5 py-3 rounded-lg transition shadow-lg shadow-yellow-500/30 w-full text-center">
                        üöÄ B·∫Øt ƒë·∫ßu ch∆°i 10 gi√¢y
                    </button>

                    <p class="text-xs text-slate-400">
                        L∆∞u √Ω: B·∫°n c√≥ th·ªÉ ch∆°i l·∫°i n·∫øu mu·ªën c·∫£i thi·ªán ƒëi·ªÉm s·ªë, h·ªá th·ªëng s·∫Ω ghi nh·∫≠n ƒëi·ªÉm c·ªßa l∆∞·ª£t m·ªõi nh·∫•t.
                    </p>

                    <p id="step2-api-message" class="hidden text-sm text-emerald-400">ƒê√£ c·∫≠p nh·∫≠t k·∫øt qu·∫£.</p>

                    <div id="step2-status"
                        class="hidden p-3 bg-emerald-500/10 border border-emerald-500/20 rounded-lg flex items-center gap-2 text-emerald-500 text-sm font-bold">
                        <span>‚úÖ ƒê√£ ghi nh·∫≠n k·∫øt qu·∫£ B∆∞·ªõc 2!</span>
                    </div>
                    <p id="reflex-best-display"
                        class="hidden text-xs text-amber-200 font-semibold text-center">
                        üèÖ ƒêi·ªÉm cao nh·∫•t: <span id="reflex-best-score">0</span>
                    </p>
                </div>

                <!-- Right: Playable board -->
                <div class="bg-slate-900/40 p-5 rounded-2xl border border-slate-700">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-sm font-semibold text-slate-200 flex items-center gap-2">
                            <span>üñ±Ô∏è</span> B·∫£ng tr√≤ ch∆°i
                        </p>
                        <span class="text-xs text-slate-400">Click v√†o chu·ªôt khi b·∫≠t l√™n</span>
                    </div>

                    <div id="punch-board" class="punch-board select-none">
                        <!-- 9 circles -->
                        <button type="button" class="punch-hole" aria-label="hole 1"><span class="punch-mouse">üê≠</span></button>
                        <button type="button" class="punch-hole" aria-label="hole 2"><span class="punch-mouse">üê≠</span></button>
                        <button type="button" class="punch-hole" aria-label="hole 3"><span class="punch-mouse">üê≠</span></button>
                        <button type="button" class="punch-hole" aria-label="hole 4"><span class="punch-mouse">üê≠</span></button>
                        <button type="button" class="punch-hole" aria-label="hole 5"><span class="punch-mouse">üê≠</span></button>
                        <button type="button" class="punch-hole" aria-label="hole 6"><span class="punch-mouse">üê≠</span></button>
                        <button type="button" class="punch-hole" aria-label="hole 7"><span class="punch-mouse">üê≠</span></button>
                        <button type="button" class="punch-hole" aria-label="hole 8"><span class="punch-mouse">üê≠</span></button>
                        <button type="button" class="punch-hole" aria-label="hole 9"><span class="punch-mouse">üê≠</span></button>
                    </div>

                    <p class="text-xs text-slate-400 mt-4 leading-relaxed text-center">
                        Chu·ªôt s·∫Ω b·∫≠t ng·∫´u nhi√™n. ƒê·∫≠p c√†ng nhi·ªÅu trong 10 gi√¢y ƒë·ªÉ tƒÉng ƒëi·ªÉm!
                    </p>
                </div>
            </div>
        </div>

        <!-- Consultation Section -->
        <div class="card p-6 rounded-2xl fade-in border-l-4 border-emerald-500 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-5 text-9xl font-black">3</div>
            <div class="flex items-center gap-4 mb-6 relative z-10">
                <div class="step-number bg-gradient-to-br from-emerald-500 to-teal-500 !shadow-emerald-500/50">3</div>
                <div>
                    <h2 class="text-xl font-bold text-white">Tr√≤ Chuy·ªán V·ªõi Chuy√™n Gia</h2>
                    <p class="text-slate-400 text-sm">ƒê·∫∑t c√¢u h·ªèi v√† nh·∫≠n t∆∞ v·∫•n c√° nh√¢n h√≥a</p>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4 relative z-10">
                <div class="space-y-4">
                    <div class="chat-message bot">
                        <div class="chat-avatar">ü§ñ</div>
                        <div class="chat-bubble bg-slate-900/80 border border-slate-700">Ch√†o b·∫°n! B·∫°n mu·ªën ph√°t tri·ªÉn k·ªπ nƒÉng n√†o sau b√†i ki·ªÉm tra?</div>
                    </div>
                    <div class="chat-message user">
                        <div class="chat-bubble bg-blue-600 text-white border-0">Em mu·ªën bi·∫øt ng√†nh n√†o ph√π h·ª£p v·ªõi kh·∫£ nƒÉng ph·∫£n x·∫° t·ªët.</div>
                        <div class="chat-avatar">üßë</div>
                    </div>
                    <div class="chat-message bot">
                        <div class="chat-avatar">ü§ñ</div>
                        <div class="chat-bubble bg-slate-900/80 border border-slate-700">Nh·ªØng ng√†nh nh∆∞ k·ªπ thu·∫≠t ƒëi·ªÅu khi·ªÉn, logistics, ƒëi·ªÅu ph·ªëi vi√™n l√† l·ª±a ch·ªçn tuy·ªát v·ªùi!</div>
                    </div>
                </div>
                <div class="flex flex-col justify-between bg-slate-900/50 border border-slate-700 rounded-2xl p-5">
                    <p class="text-slate-300 text-sm leading-relaxed mb-4">
                        H√£y tr√≤ chuy·ªán v·ªõi chuy√™n gia AI ƒë·ªÉ nh·∫≠n ph√¢n t√≠ch s√¢u h∆°n v·ªÅ k·∫øt qu·∫£ c·ªßa b·∫°n, l·ªô tr√¨nh ngh·ªÅ nghi·ªáp,
                        c≈©ng nh∆∞ nh·ªØng k·ªπ nƒÉng c·∫ßn r√®n luy·ªán ti·∫øp theo.
                    </p>
                    <button onclick="openChatModal()"
                        class="bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-bold px-6 py-3 rounded-xl shadow-lg shadow-emerald-500/20 transition-all">
                        M·ªü khung tr√≤ chuy·ªán
                    </button>
                </div>
            </div>
        </div>
<!-- 
        <div class="flex items-center gap-3 text-sm text-emerald-300 bg-slate-900/50 border border-emerald-500/20 rounded-xl px-4 py-3">
            <span class="relative flex h-3 w-3">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
            </span>
            ƒê·ªô ch√≠nh x√°c AI: {{ accuracy }}%
        </div> -->

        <!-- Final Result Section -->
        <button onclick="getFinalAdvice()" id="get-result-btn"
            class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white p-4 rounded-xl text-lg font-bold shadow-xl shadow-blue-500/20 transition-all transform hover:-translate-y-1">
            üìò Get Final Report
        </button>

        <div id="result-card"
            class="bg-gradient-to-br from-slate-800 to-slate-900 p-8 rounded-2xl shadow-2xl border border-slate-700 hidden">
            <h2
                class="text-3xl font-bold text-center mb-8 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
                K·∫øt Qu·∫£ Ph√¢n T√≠ch</h2>

            <div class="flex flex-col md:flex-row gap-8 mb-8">
                <div class="flex-1 text-center p-6 bg-slate-800/50 rounded-xl border border-slate-700">
                    <div class="text-sm text-slate-400 mb-2">Nh√≥m T√≠nh C√°ch</div>
                    <div id="group-result" class="text-5xl font-black text-white mb-2">?</div>
                    <div id="desc-result" class="text-emerald-400 font-medium">--</div>
                </div>

                <div class="flex-[1.5]">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <span class="text-blue-500">üöÄ</span> Ngh·ªÅ Nghi·ªáp ƒê·ªÅ Xu·∫•t
                    </h3>
                    <ul id="career-list" class="space-y-3">
                        <!-- Items injected by JS -->
                    </ul>
                </div>
            </div>
        </div>

        <div id="final-report-card"
            class="hidden bg-slate-900/70 border border-white/10 rounded-2xl p-6 shadow-2xl space-y-4">
            <div class="flex items-center justify-between gap-3">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">
                    üìÑ B√°o c√°o c√° nh√¢n ho√°
                </h3>
                <span id="report-status" class="text-xs text-slate-400 uppercase tracking-[0.2em]">ƒêang x·ª≠ l√Ω</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div class="bg-slate-900/60 border border-slate-700 rounded-xl p-4">
                    <p class="text-slate-400 text-xs uppercase tracking-wide">H·ªç v√† t√™n</p>
                    <p id="report-name" class="text-white font-semibold mt-1">--</p>
                </div>
                <div class="bg-slate-900/60 border border-slate-700 rounded-xl p-4">
                    <p class="text-slate-400 text-xs uppercase tracking-wide">Tu·ªïi</p>
                    <p id="report-age" class="text-white font-semibold mt-1">--</p>
                </div>
                <div class="bg-slate-900/60 border border-slate-700 rounded-xl p-4">
                    <p class="text-slate-400 text-xs uppercase tracking-wide">L·ªõp</p>
                    <p id="report-class" class="text-white font-semibold mt-1">--</p>
                </div>
                <div class="bg-slate-900/60 border border-slate-700 rounded-xl p-4">
                    <p class="text-slate-400 text-xs uppercase tracking-wide">Ng√†nh ngh·ªÅ ph√π h·ª£p</p>
                    <p id="report-fit-job" class="text-emerald-300 font-semibold mt-1">--</p>
                </div>
            </div>
            <div class="bg-slate-900/50 border border-slate-800 rounded-xl p-4">
                <p class="text-slate-400 text-xs uppercase tracking-wide mb-2">Gi·∫£i th√≠ch</p>
                <p id="report-explanation" class="text-slate-100 text-sm leading-relaxed">--</p>
            </div>
        </div>

    </div>

    <!-- Floating Chat Button -->
    <!-- <div class="fixed bottom-6 right-6 z-40">
        <button onclick="openChatModal()" id="chat-open-btn"
            class="bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold px-5 py-3 rounded-full shadow-lg shadow-emerald-500/30 flex items-center gap-2">
            üí¨ Chat v·ªõi AI
        </button>
    </div> -->

    <!-- Chat Modal -->
    <div id="chat-modal" class="hidden fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-40">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="w-full max-w-lg bg-slate-900 border border-white/10 rounded-2xl shadow-2xl relative">
                <div class="flex items-center justify-between p-4 border-b border-white/10">
                    <div class="flex items-center gap-3">
                        <div class="chat-avatar bg-emerald-500/20 border border-emerald-400/30 text-emerald-300">
                            ü§ñ
                        </div>
                        <div>
                            <p class="text-sm text-emerald-300 uppercase font-semibold">AI Career Assistant</p>
                            <p class="text-xs text-slate-400">H·ªèi t√¥i b·∫•t c·ª© ƒëi·ªÅu g√¨ v·ªÅ h·ªá th·ªëng</p>
                        </div>
                    </div>
                    <button onclick="closeChatModal()"
                        class="text-slate-400 hover:text-white transition-colors text-xl">&times;</button>
                </div>
                <div class="p-4 max-h-[60vh] overflow-y-auto" id="chat-messages">
                    <!-- Messages injected via JS -->
                </div>
                <div class="p-4 border-t border-white/10 bg-slate-900/80">
                    <div class="flex items-center gap-2">
                        <textarea id="chat-input"
                            class="flex-1 bg-slate-800/80 border border-slate-700 rounded-xl p-3 text-sm text-white resize-none focus:outline-none focus:border-emerald-400 h-16"
                            placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n... (Enter ƒë·ªÉ g·ª≠i)"></textarea>
                        <button id="chat-send-btn" onclick="sendChatMessage()"
                            class="bg-emerald-500 hover:bg-emerald-400 text-slate-900 font-semibold px-4 py-3 rounded-xl transition disabled:opacity-50 disabled:cursor-not-allowed">G·ª≠i</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script> -->
    <script>
        // State
        let bestStep1 = {{ best_step1 | tojson | default('null', true) }} || null;
        let bestReflex = {{ best_reflex | tojson | default('null', true) }} || null;
        let wireLoopResult = {
            time: bestStep1?.time || 0,
            errors: bestStep1?.errors || 0,
            done: Boolean(bestStep1)
        };
        let whackResult = {
            score: bestReflex?.quantity || 0,
            done: Boolean(bestReflex)
        };
        let studentInfo = {{ student_info | tojson | default('null', true) }} || null;
        let testsCompleted = {{ tests_completed | tojson | default('false') }} || false;
        let reflexBestScore = bestReflex?.quantity || 0;
        let lastTimestamp = 0;
        let chatInitialized = false;
        let chatWaiting = false;
        const REFLEX_DURATION_SECONDS = 10;
        let reflexGameActive = false;
        let reflexScore = 0;
        let reflexTimeRemaining = REFLEX_DURATION_SECONDS;
        let reflexSpawnInterval = null;
        let reflexCountdownInterval = null;
        let reflexGameTimeout = null;

        const chatModal = document.getElementById('chat-modal');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const step1MessageEl = document.getElementById('step1-api-message');
        const step2MessageEl = document.getElementById('step2-api-message');
        const studentModal = document.getElementById('student-info-modal');
        const studentForm = document.getElementById('student-info-form');
        const studentErrorEl = document.getElementById('student-info-error');
        const studentFullNameInput = document.getElementById('student-fullname');
        const studentAgeInput = document.getElementById('student-age');
        const studentGenderSelect = document.getElementById('student-gender');
        const studentGradeSelect = document.getElementById('student-grade');
        const studentClassInput = document.getElementById('student-class');
        const homeLink = document.getElementById('home-link');
        const homeLockMessage = document.getElementById('home-lock-message');
        const reportCard = document.getElementById('final-report-card');
        const reportStatus = document.getElementById('report-status');
        const reportNameEl = document.getElementById('report-name');
        const reportAgeEl = document.getElementById('report-age');
        const reportClassEl = document.getElementById('report-class');
        const reportFitJobEl = document.getElementById('report-fit-job');
        const reportExplanationEl = document.getElementById('report-explanation');
        const reflexTimeRemainingEl = document.getElementById('reflex-time-remaining');
        const reflexScoreEl = document.getElementById('reflex-score');
        const reflexStatusEl = document.getElementById('reflex-status');
        const reflexStartBtn = document.getElementById('reflex-start-btn');
        const step1BestSummary = document.getElementById('step1-best-summary');
        const step1BestTimeEl = document.getElementById('best-step1-time');
        const step1BestErrorsEl = document.getElementById('best-step1-errors');
        const reflexBestDisplay = document.getElementById('reflex-best-display');
        const reflexBestScoreEl = document.getElementById('reflex-best-score');

        function showStudentInfoModal() {
            if (studentModal) {
                studentModal.classList.remove('hidden');
            }
        }

        function hideStudentInfoModal() {
            if (studentModal) {
                studentModal.classList.add('hidden');
            }
        }

        function updateHomeLinkState() {
            if (!homeLink) return;
            if (testsCompleted) {
                homeLink.classList.remove('opacity-60', 'cursor-not-allowed', 'pointer-events-none');
                homeLink.classList.add('hover:text-emerald-200');
                homeLink.setAttribute('aria-disabled', 'false');
                if (homeLockMessage) {
                    homeLockMessage.classList.add('hidden');
                }
            } else {
                homeLink.classList.add('opacity-60', 'cursor-not-allowed', 'pointer-events-none');
                homeLink.classList.remove('hover:text-emerald-200');
                homeLink.setAttribute('aria-disabled', 'true');
                if (homeLockMessage) {
                    homeLockMessage.classList.remove('hidden');
                }
            }
        }

        function updateReflexDisplays() {
            if (reflexTimeRemainingEl) {
                reflexTimeRemainingEl.textContent = `${Math.max(reflexTimeRemaining, 0)}s`;
            }
            if (reflexScoreEl) {
                reflexScoreEl.textContent = reflexScore.toString();
            }
        }

        function setReflexStatus(text) {
            if (reflexStatusEl) {
                reflexStatusEl.textContent = text;
            }
        }

        function setStep1Best(best) {
            if (!step1BestSummary || !step1BestTimeEl || !step1BestErrorsEl) return;
            if (!best) {
                step1BestSummary.classList.add('hidden');
                return;
            }
            const bestTime = typeof best.time === 'number' ? best.time : parseFloat(best.time || 0);
            const bestErrors = typeof best.errors === 'number' ? best.errors : parseInt(best.errors || 0);
            step1BestTimeEl.textContent = bestTime.toFixed(2);
            step1BestErrorsEl.textContent = bestErrors.toString();
            step1BestSummary.classList.remove('hidden');
        }

        function setReflexBest(score) {
            if (!reflexBestDisplay || !reflexBestScoreEl) return;
            if (!score || score <= 0) {
                reflexBestDisplay.classList.add('hidden');
                return;
            }
            reflexBestScoreEl.textContent = score.toString();
            reflexBestDisplay.classList.remove('hidden');
        }

        async function handleStudentInfoSubmit(event) {
            event.preventDefault();
            const fullName = (studentFullNameInput?.value || '').trim();
            const age = (studentAgeInput?.value || '').trim();
            const gender = studentGenderSelect?.value || '';
            const grade = studentGradeSelect?.value || '';
            const className = (studentClassInput?.value || '').trim();

            if (!fullName || !age || !gender || !grade || !className) {
                if (studentErrorEl) {
                    studentErrorEl.textContent = "Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.";
                    studentErrorEl.classList.remove('hidden');
                }
                return;
            }

            try {
                const response = await fetch('/api/student_info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        full_name: fullName,
                        age,
                        gender,
                        grade,
                        class_name: className
                    })
                });
                const data = await response.json();
                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Kh√¥ng th·ªÉ l∆∞u th√¥ng tin.');
                }
                studentInfo = data.student_info || {
                    full_name: fullName,
                    age,
                    gender,
                    grade,
                    class_name: className
                };
                if (studentErrorEl) {
                    studentErrorEl.classList.add('hidden');
                }
                hideStudentInfoModal();
            } catch (err) {
                if (studentErrorEl) {
                    studentErrorEl.textContent = err.message || 'Kh√¥ng th·ªÉ l∆∞u th√¥ng tin.';
                    studentErrorEl.classList.remove('hidden');
                }
            }
        }

        if (studentForm) {
            studentForm.addEventListener('submit', handleStudentInfoSubmit);
        }

        if (homeLink) {
            homeLink.addEventListener('click', (event) => {
                if (!testsCompleted) {
                    event.preventDefault();
                    alert('Ho√†n th√†nh b√°o c√°o ƒë·ªÉ quay l·∫°i trang ch·ªß.');
                }
            });
        }

        // --- Socket.IO Connection (Step 1) ---
        // const socket = io();

        // socket.on('connect', () => {
        //     console.log('Connected to WebSocket server');
        // });

        // socket.on('disconnect', () => {
        //     console.log('Disconnected from server');
        // });

        // socket.on('game_update', (data) => {
        //     if (data && data.status !== 'idle') {
        //         if (data.status === 'playing') {
        //             document.getElementById('live-monitor').classList.remove('hidden');
        //             document.getElementById('step1-manual-form').classList.remove('hidden');
        //             document.getElementById('step1-result-display').classList.add('hidden');
        //
        //             document.getElementById('live-time').innerText = data.time.toFixed(1);
        //             document.getElementById('live-errors').innerText = data.errors;
        //         }
        //         else if (data.status === 'finished' && data.timestamp > lastTimestamp) {
        //             lastTimestamp = data.timestamp;
        //
        //             // Lock Step 1
        //             document.getElementById('input-time').value = data.time;
        //             document.getElementById('input-errors').value = data.errors;
        //
        //             document.getElementById('display-time').innerText = data.time;
        //             document.getElementById('display-errors').innerText = data.errors;
        //             wireLoopResult.time = data.time;
        //             wireLoopResult.errors = data.errors;
        //
        //             document.getElementById('live-monitor').classList.add('hidden');
        //             document.getElementById('step1-manual-form').classList.add('hidden');
        //             document.getElementById('step1-result-display').classList.remove('hidden');
        //
        //             updateStep1Status(true);
        //         }
        //     }
        // });

        // Manual Input Listener Step 1
        const inputTime = document.getElementById('input-time');
        const inputErrors = document.getElementById('input-errors');
        function onManualInput() {
            if (inputTime.value !== '' && inputErrors.value !== '') {
                updateStep1Status(true);
            } else {
                updateStep1Status(false);
            }
        }
        inputTime.addEventListener('input', onManualInput);
        inputErrors.addEventListener('input', onManualInput);

        function setInlineMessage(el, text, isError = false) {
            if (!el) return;
            el.textContent = text;
            el.classList.remove('hidden');
            el.classList.toggle('text-emerald-400', !isError);
            el.classList.toggle('text-red-400', isError);
        }

        function clearInlineMessage(el) {
            if (!el) return;
            el.classList.add('hidden');
        }

        async function submitWireLoopResult() {
            const submitBtn = document.getElementById('wire-submit-btn');
            const timeVal = parseFloat(inputTime.value);
            const errorVal = parseInt(inputErrors.value);
            if (isNaN(timeVal) || isNaN(errorVal)) {
                setInlineMessage(step1MessageEl, "Vui l√≤ng nh·∫≠p ƒë·ªß th·ªùi gian v√† s·ªë l·ªói.", true);
                return;
            }
            setInlineMessage(step1MessageEl, "‚è≥ ƒêang g·ª≠i k·∫øt qu·∫£...", false);
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-70', 'cursor-not-allowed');
            try {
                const response = await fetch('/api/game_event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ event: 'finish', time: timeVal, errors: errorVal })
                });
                const data = await response.json();
                if (!response.ok || data.error) {
                    throw new Error(data.error || 'Kh√¥ng th·ªÉ l∆∞u k·∫øt qu·∫£.');
                }
                const bestData = data.best || { time: timeVal, errors: errorVal };
                bestStep1 = bestData;
                wireLoopResult.time = bestData.time;
                wireLoopResult.errors = bestData.errors;
                wireLoopResult.done = true;
                inputTime.value = bestData.time;
                inputErrors.value = bestData.errors;
                updateStep1Status(true);
                setStep1Best(bestData);
                const successMsg = data.improved
                    ? "üéâ K·ª∑ l·ª•c m·ªõi cho Wire Loop!"
                    : "‚ÑπÔ∏è ƒê√£ l∆∞u k·∫øt qu·∫£ (ch∆∞a v∆∞·ª£t k·ª∑ l·ª•c).";
                setInlineMessage(step1MessageEl, successMsg, false);
            } catch (err) {
                setInlineMessage(step1MessageEl, err.message || 'C√≥ l·ªói x·∫£y ra.', true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        }

        function updateStep1Status(isDone) {
            wireLoopResult.done = isDone;
            document.getElementById('step1-status').classList.toggle('hidden', !isDone);
            checkAllDone();
        }

        function resetStep1() {
            document.getElementById('step1-result-display').classList.add('hidden');
            document.getElementById('step1-manual-form').classList.remove('hidden');
            document.getElementById('input-time').value = '';
            document.getElementById('input-errors').value = '';
            clearInlineMessage(step1MessageEl);
            updateStep1Status(false);
        }

        // --- Reflex Game Logic ---
        const punchBoardController = {
            clear() {},
            spawn() {}
        };

        function initPunchBoard() {
            const board = document.getElementById('punch-board');
            if (!board) return;

            const holes = Array.from(board.querySelectorAll('.punch-hole'));
            let lastIdx = -1;

            function randomIdx() {
                if (holes.length === 1) return 0;
                let i = Math.floor(Math.random() * holes.length);
                if (i === lastIdx) i = (i + 1) % holes.length;
                lastIdx = i;
                return i;
            }

            function clearHoles() {
                holes.forEach((hole) => hole.classList.remove('up'));
            }

            function spawnHole() {
                if (!reflexGameActive) {
                    clearHoles();
                    return;
                }
                clearHoles();
                const idx = randomIdx();
                const hole = holes[idx];
                hole.classList.add('up');
                setTimeout(() => hole.classList.remove('up'), 600);
            }

            holes.forEach((hole) => {
                hole.addEventListener('pointerdown', (event) => {
                    event.preventDefault();
                    if (!event.isTrusted) return;
                    if (!reflexGameActive) return;
                    if (!hole.classList.contains('up')) return;
                    hole.classList.add('hit');
                    setTimeout(() => hole.classList.remove('hit'), 220);
                    hole.classList.remove('up');
                    reflexScore += 1;
                    updateReflexDisplays();
                }, { passive: false });
            });

            punchBoardController.clear = clearHoles;
            punchBoardController.spawn = spawnHole;
        }

        initPunchBoard();

        function stopReflexTimers() {
            if (reflexSpawnInterval) {
                clearInterval(reflexSpawnInterval);
                reflexSpawnInterval = null;
            }
            if (reflexCountdownInterval) {
                clearInterval(reflexCountdownInterval);
                reflexCountdownInterval = null;
            }
            if (reflexGameTimeout) {
                clearTimeout(reflexGameTimeout);
                reflexGameTimeout = null;
            }
        }

        function enableReflexStartBtn(enable) {
            if (!reflexStartBtn) return;
            reflexStartBtn.disabled = !enable;
            reflexStartBtn.classList.toggle('opacity-70', !enable);
            reflexStartBtn.classList.toggle('cursor-not-allowed', !enable);
        }

        function startReflexGame() {
            if (reflexGameActive) return;
            reflexGameActive = true;
            reflexScore = 0;
            reflexTimeRemaining = REFLEX_DURATION_SECONDS;
            setReflexStatus("ƒêang ch∆°i...");
            updateReflexDisplays();
            clearInlineMessage(step2MessageEl);
            enableReflexStartBtn(false);

            punchBoardController.clear();
            punchBoardController.spawn();
            reflexSpawnInterval = setInterval(() => punchBoardController.spawn(), 650);

            reflexCountdownInterval = setInterval(() => {
                reflexTimeRemaining -= 1;
                updateReflexDisplays();
                if (reflexTimeRemaining <= 0) {
                    finishReflexGame();
                }
            }, 1000);

            reflexGameTimeout = setTimeout(() => {
                finishReflexGame();
            }, REFLEX_DURATION_SECONDS * 1000);
        }

        function finishReflexGame() {
            if (!reflexGameActive) return;
            reflexGameActive = false;
            stopReflexTimers();
            reflexTimeRemaining = 0;
            updateReflexDisplays();
            punchBoardController.clear();
            setReflexStatus("ƒêang g·ª≠i k·∫øt qu·∫£...");
            submitReflexResult();
        }

        async function saveReflexResult(timeVal, quantityVal) {
            const response = await fetch('/api/reflex_result', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ time: timeVal, quantity: quantityVal })
            });
            const data = await response.json();
            if (!response.ok || data.error) {
                throw new Error(data.error || 'Kh√¥ng th·ªÉ l∆∞u k·∫øt qu·∫£ ph·∫£n x·∫°.');
            }
            return data;
        }

        async function submitReflexResult() {
            setInlineMessage(step2MessageEl, "‚è≥ ƒêang g·ª≠i k·∫øt qu·∫£...", false);
            try {
                const payload = await saveReflexResult(REFLEX_DURATION_SECONDS, reflexScore);
                const bestData = payload.best || { quantity: reflexScore };
                bestReflex = bestData;
                reflexBestScore = bestData.quantity || reflexScore;
                whackResult.score = reflexBestScore;
                whackResult.done = true;
                document.getElementById('step2-status').classList.remove('hidden');
                checkAllDone();
                setReflexBest(reflexBestScore);
                const successMsg = payload.improved
                    ? `üéâ K·ª∑ l·ª•c m·ªõi: ${reflexBestScore} chu·ªôt!`
                    : "‚ÑπÔ∏è ƒê√£ l∆∞u k·∫øt qu·∫£ (ch∆∞a v∆∞·ª£t k·ª∑ l·ª•c).";
                setInlineMessage(step2MessageEl, successMsg, false);
                setReflexStatus(
                    payload.improved
                        ? `Ho√†n t·∫•t! ƒêi·ªÉm m·ªõi: ${reflexBestScore}`
                        : `Ho√†n t·∫•t! K·ª∑ l·ª•c hi·ªán t·∫°i: ${reflexBestScore}`
                );
            } catch (err) {
                setInlineMessage(step2MessageEl, err.message || 'C√≥ l·ªói x·∫£y ra.', true);
                setReflexStatus("G·ª≠i d·ªØ li·ªáu th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.");
            } finally {
                enableReflexStartBtn(true);
            }
        }

        // --- Final Submission ---
        function checkAllDone() {
            const btn = document.getElementById('get-result-btn');
            if (!btn) return;
            const ready = wireLoopResult.done && whackResult.done;
            btn.classList.toggle('opacity-50', !ready);
        }

        async function getFinalAdvice() {
            if (!studentInfo) {
                alert("Vui l√≤ng nh·∫≠p th√¥ng tin h·ªçc sinh tr∆∞·ªõc khi xem b√°o c√°o.");
                showStudentInfoModal();
                return;
            }

            const allDone = wireLoopResult.done && whackResult.done;
            if (!allDone) {
                const proceed = confirm("B·∫°n ch∆∞a ho√†n th√†nh t·∫•t c·∫£ b√†i ki·ªÉm tra. B√°o c√°o c√≥ th·ªÉ kh√¥ng ch√≠nh x√°c. B·∫°n c√≥ mu·ªën ti·∫øp t·ª•c?");
                if (!proceed) {
                    return;
                }
            }

            const t = parseFloat(document.getElementById('input-time').value);
            const e = parseInt(document.getElementById('input-errors').value);
            const s = whackResult.score;

            if (isNaN(t) || isNaN(e)) {
                alert("Vui l√≤ng ki·ªÉm tra l·∫°i k·∫øt qu·∫£ b√†i 1!");
                return;
            }

            const reportBtn = document.getElementById('get-result-btn');

            try {
                if (reportBtn) {
                    reportBtn.innerText = "‚è≥ ƒêang ph√¢n t√≠ch...";
                }

                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ time: t, errors: e, score: s })
                });
                const data = await response.json();

                if (data.error) { alert('L·ªói: ' + data.error); return; }

                // Display prediction summary
                const groupEl = document.getElementById('group-result');
                groupEl.innerText = data.group;
                groupEl.className = "text-5xl font-black mb-2 " + (data.group === 'A' ? "text-blue-500" : data.group === 'B' ? "text-emerald-500" : "text-purple-500");

                let desc = "";
                if (data.group === 'A') {
                    desc = "Ng∆∞·ªùi ƒëi·ªÅu h√†nh: Ph·∫£n x·∫° th·∫ßn t·ªëc & Ki·ªÉm so√°t t√¨nh hu·ªëng tuy·ªát v·ªùi.";
                } else if (data.group === 'B') {
                    desc = "Ngh·ªá nh√¢n: ƒê√¥i tay kh√©o l√©o, t·ªâ m·ªâ & S·ª± t·∫≠p trung b·ªÅn b·ªâ.";
                } else {
                    desc = "Nh√† chi·∫øn l∆∞·ª£c: Thi√™n h∆∞·ªõng T∆∞ duy qu·∫£n l√Ω & Ph√¢n t√≠ch (√≠t thi√™n v·ªÅ thao t√°c).";
                }
                document.getElementById('desc-result').innerText = desc;

                const list = document.getElementById('career-list');
                list.innerHTML = '';
                data.careers.forEach(c => {
                    list.innerHTML += `<li class="p-3 bg-slate-900 rounded-lg border border-slate-700 flex items-center gap-3">
                        <span class="w-2 h-2 rounded-full bg-blue-500"></span>${c}
                    </li>`
                });

                document.getElementById('result-card').classList.remove('hidden');
                document.getElementById('result-card').scrollIntoView({ behavior: "smooth" });

                if (reportBtn) {
                    reportBtn.innerText = "‚è≥ ƒêang t·∫°o b√°o c√°o...";
                }
                await generateFinalReport(
                    { group: data.group, careers: data.careers },
                    desc
                );
                if (reportBtn) {
                    reportBtn.innerText = "üìò Get Final Report";
                }

            } catch (err) {
                console.error(err);
                alert(err.message || 'L·ªói k·∫øt n·ªëi server!');
                if (reportBtn) {
                    reportBtn.innerText = "üìò Get Final Report";
                }
            }
        }

        async function generateFinalReport(predictionData, summaryText) {
            if (reportCard) {
                reportCard.classList.remove('hidden');
            }
            if (reportStatus) {
                reportStatus.textContent = "ƒêang x·ª≠ l√Ω";
            }
            try {
                const response = await fetch('/api/final_report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        group: predictionData.group,
                        careers: predictionData.careers,
                        summary: summaryText
                    })
                });
                const payload = await response.json();
                if (!response.ok || payload.error) {
                    throw new Error(payload.error || 'Kh√¥ng th·ªÉ t·∫°o b√°o c√°o.');
                }

                if (reportNameEl) reportNameEl.textContent = payload.name || studentInfo?.full_name || '--';
                if (reportAgeEl) reportAgeEl.textContent = payload.age || studentInfo?.age || '--';
                if (reportClassEl) reportClassEl.textContent = payload.class || studentInfo?.class_name || '--';
                if (reportFitJobEl) reportFitJobEl.textContent = payload.fit_job || '--';
                if (reportExplanationEl) reportExplanationEl.textContent = payload.explanation || '--';
                if (reportStatus) {
                    reportStatus.textContent = "Ho√†n t·∫•t";
                }
                testsCompleted = true;
                updateHomeLinkState();
            } catch (err) {
                if (reportStatus) {
                    reportStatus.textContent = "L·ªói";
                }
                throw err;
            }
        }

        // --- Chatbot Modal ---
        function openChatModal() {
            chatModal.classList.remove('hidden');
            if (!chatInitialized) {
                appendChatMessage('bot', 'Xin ch√†o! T√¥i c√≥ th·ªÉ gi·∫£i ƒë√°p th·∫Øc m·∫Øc v·ªÅ quy tr√¨nh ki·ªÉm tra v√† g·ª£i √Ω ngh·ªÅ nghi·ªáp.');
                chatInitialized = true;
            }
            setTimeout(() => chatInput.focus(), 100);
        }

        function closeChatModal() {
            chatModal.classList.add('hidden');
        }

        function sanitizeMarkdownEmphasis(input) {
            return input.replace(/\*\*(.*?)\*\*/g, '$1');
        }

        function appendChatMessage(role, text) {
            const wrapper = document.createElement('div');
            wrapper.className = `chat-message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'chat-avatar';
            avatar.textContent = role === 'bot' ? 'ü§ñ' : 'üßë';

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';
            bubble.textContent = sanitizeMarkdownEmphasis(text);

            if (role === 'user') {
                wrapper.appendChild(bubble);
                wrapper.appendChild(avatar);
            } else {
                wrapper.appendChild(avatar);
                wrapper.appendChild(bubble);
            }

            chatMessages.appendChild(wrapper);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function setChatLoading(state) {
            chatWaiting = state;
            chatSendBtn.disabled = state;
            chatSendBtn.textContent = state ? 'ƒêang tr·∫£ l·ªùi...' : 'G·ª≠i';
        }

        async function sendChatMessage() {
            if (chatWaiting) return;
            const message = chatInput.value.trim();
            if (!message) return;

            appendChatMessage('user', message);
            chatInput.value = '';
            setChatLoading(true);

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await response.json();
                if (data.error) {
                    appendChatMessage('bot', 'Xin l·ªói, t√¥i ch∆∞a nh·∫≠n ƒë∆∞·ª£c c√¢u h·ªèi. Vui l√≤ng th·ª≠ l·∫°i nh√©!');
                } else {
                    appendChatMessage('bot', data.reply);
                }
            } catch (err) {
                console.error(err);
                appendChatMessage('bot', 'C√≥ l·ªói k·∫øt n·ªëi. B·∫°n th·ª≠ l·∫°i sau nh√©!');
            } finally {
                setChatLoading(false);
            }
        }

        chatInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        });

        setStep1Best(bestStep1);
        setReflexBest(reflexBestScore);
        checkAllDone();
        updateHomeLinkState();
        if (studentInfo && studentInfo.age) {
            hideStudentInfoModal();
        } else {
            showStudentInfoModal();
        }

    </script>
</body>

</html>
